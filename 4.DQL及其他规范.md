# DQL及其他规范

### 1.使用模型外键时，禁止flask自动生成表结构

- 存在外键

### 2.单条查询建议 `指定字段` 且使用 `.first()`

- 指定字段会返回 `sqlalchemy.engine.row.Row`
    - 不指定字段返回 `Model`，相当于全字段查询，浪费I/O
    - 指定字段查询建议加在 query中，不建议使用 `.with_entities`，以后版本可能删除
- .first() 会在SQL结尾添加 `limit 1`，确保返回一行
    - 不推荐使用 `.one()`，返回超过一行会抛出异常

```python
# 1.不指定字段查询，不推荐
model_obj = db.session.query(Xxx).select_from(Xxx). \
    filter(Xxx.xxx_id == 'a872e3f879d13e799acf7ef724eaee21').first()

"""实际执行SQL
SELECT t_xxx.id AS t_xxx_id
	,t_xxx.xxx_id AS t_xxx_xxx_id
	,t_xxx.xxx_type AS t_xxx_xxx_type
	,t_xxx.xxx_name AS t_xxx_xxx_name
	,t_xxx.xxx_name_bin AS t_xxx_xxx_name_bin
	,t_xxx.xxx_price AS t_xxx_xxx_price
	,t_xxx.is_deleted AS t_xxx_is_deleted
	,t_xxx.create_time AS t_xxx_create_time
	,t_xxx.update_time AS t_xxx_update_time
FROM t_xxx
WHERE t_xxx.xxx_id = 'a872e3f879d13e799acf7ef724eaee21' 
LIMIT 1
"""

# 2.指定字段查询，推荐
row = db.session.query(Xxx.xxx_id, Xxx.xxx_name).select_from(Xxx). \
    filter(Xxx.xxx_id == 'a872e3f879d13e799acf7ef724eaee21').first()

"""实际执行SQL
SELECT t_xxx.xxx_id AS t_xxx_xxx_id
	,t_xxx.xxx_name AS t_xxx_xxx_name
FROM t_xxx
WHERE t_xxx.xxx_id = 'a872e3f879d13e799acf7ef724eaee21' 
LIMIT 1
"""
```

### 3.多条查询建议 `指定字段` 且使用 `.all()`

- 返回类型: `List[sqlalchemy.engine.row.Row]`

```python
result = db.session.query(Xxx.xxx_id, Xxx.xxx_name).select_from(Xxx).all()

"""实际执行SQL
SELECT t_xxx.xxx_id AS t_xxx_xxx_id
	,t_xxx.xxx_name AS t_xxx_xxx_name
FROM t_xxx
"""
```

### 4.禁止使用 `切片`，使用 `.offset().limit()` 实现分页

- .offset(m).limit(n) 对应mysql的 `limit m, n`
- SQLAlchemy切片与django ORM切片实现原理不同
    - django ORM切片是真分页
    - SQLAlchemy的切片是假分页，逻辑层数据切片

```python
result = db.session.query(Xxx.xxx_id, Xxx.xxx_name).select_from(Xxx).offset(11).limit(2).all()

"""实际执行SQL
SELECT t_xxx.xxx_id AS t_xxx_xxx_id
	,t_xxx.xxx_name AS t_xxx_xxx_name
FROM t_xxx 
LIMIT 11, 2
"""
```

### 5.如果结果仅用于判断推荐使用 `db.session.query(db.literal(1)) ... .first()`

- 对应mysql的 `select 1 ... limit 1`
- 仅返回一个自定义标量 `1`，I/O消耗极低

```python
if db.session.query(db.literal(1)).select_from(Xxx).filter(Xxx.id >= 100).first():
    pass

"""实际执行SQL
SELECT 1 AS anon_1 
FROM t_xxx 
WHERE t_xxx.id >= 100 
LIMIT 1
"""
```

